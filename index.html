<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>KPG Map</title>
  <style>#map { height: 600px; width: 100%; }</style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4IGLPtG-Ql2wKO9VePaPFiRkJPZlhVa4"></script> 
  <!--API KEY:  AIzaSyC4IGLPtG-Ql2wKO9VePaPFiRkJPZlhVa4 -->
</head>
<body>
  <h2>KPG Map</h2>
  <div id="map"></div>
  <script>
    async function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        center: {lat: 27.062699515060125, lng: 88.4672654852272},
        zoom: 15,
      });

      // スプレッドシートのデータを取得
      const res = await fetch("https://script.google.com/macros/s/AKfycbxvlzZsYiN7aBO75Sb9tN-ZXFXSUq8pA54jo65hd3-nmd0RXGDpBs-LFJ5Gz3HDJzH8/exec");
      const rows = await res.json();
      const byId = Object.fromEntries(rows.map(r => [String(r.area_id), r]));

      // GeoJSONを読み込み
      map.data.loadGeoJson("https://raw.githubusercontent.com/TKalimpong/kpg-map/refs/heads/main/map.geojson");

      // スタイル設定
      map.data.setStyle(feature => {
        const row = byId[String(feature.getProperty("name"))]; // GeoJSONのidとシートのarea_idを対応
        let color = "#ccc";
        if (row) {
          if (row.status == "1year") color = "green";
          else if (row.status == "Do") color = "blue";
          else if (row.status == "Re") color = "gray";
        }
        return { fillColor: color, strokeColor: "#333", strokeWeight: 1, fillOpacity: 0.6, clickable: true, label: feature.getProperty("name")};
      });

      

      map.data.addListener("click", event => {
        const name = event.feature.getProperty("name");
        infowindow.setContent(name);
        infowindow.setPosition(event.latLng);
        infowindow.open(map);
      });

      const infowindow = new google.maps.InfoWindow();
      // map.data.setStyle(feature => {
      //   return {
      //     label: feature.getProperty("name"),
      //     icon: {
      //       path: google.maps.SymbolPath.CIRCLE,
      //       scale: 6,
      //       fillColor: "blue",
      //       fillOpacity: 0.8,
      //       strokeColor: "white",
      //       strokeWeight: 1
      //     }
      //   };
      // });

      
    }
    
    

    window.onload = initMap;
  </script>
</body>
</html>